<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TraficLib - Horaires du r√©seau Naolib en temps r√©el !</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f4f5f8;
      }
      header {
        background: #2fdb0d;
        color: #fff;
        padding: 12px;
        text-align: center;
      }
      #controls {
        display: flex;
        gap: 8px;
        padding: 12px;
        background: #fff;
        align-items: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      }
      #controls input {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #d8dbe0;
        font-size: 14px;
      }
      #controls button {
        padding: 9px 12px;
        border-radius: 8px;
        border: 0;
        background: #2fdb0d;
        color: #fff;
        cursor: pointer;
      }
      #main {
        display: flex;
        height: 75vh;
      }
      #map {
        flex: 2;
      }
      #sidebar {
        flex: 1;
        background: #fff;
        padding: 12px;
        overflow: auto;
        box-shadow: -2px 0 6px rgba(0, 0, 0, 0.04);
      }
      .stop {
        border-radius: 10px;
        border: 1px solid #eef0f3;
        padding: 10px;
        margin-bottom: 10px;
        background: #fff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
      }
      .line {
        font-weight: 700;
        color: #2fdb0d;
      }
      .hint {
        color: #6b7280;
        font-size: 13px;
      }
      ul {
        margin: 6px 0 0 18px;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>TraficLib - Nantes</h1>
    </header>

    <div id="controls">
      <input id="locInput" placeholder="Nom d'arr√™t (ex: Commerce)" />
      <button id="searchBtn">üîç Chercher</button>
      <button id="locBtn">üìç Ma position</button>
    </div>

    <div id="main">
      <div id="map"></div>
      <div id="sidebar">
        <h2>R√©sultats</h2>
        <div id="results"></div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      (async () => {
        /* ===========================
        I ‚Äî DONN√âES MOCK (exemple)
      =========================== */
        const stops = await new Promise(async (resolve) => {
          const response = await fetch(
            "https://data.nantesmetropole.fr/api/explore/v2.1/catalog/datasets/244400404_tan-arrets/exports/json?lang=fr&timezone=Europe%2FBerlin"
          );
          const stops = (await response.json()).filter(
            (s) => s.location_type == 1
          );
          resolve(
            stops.map((s) => ({
              stop_id: s.stop_id,
              stop_name: s.stop_name,
              stop_lat: s.stop_coordinates.lat,
              stop_lon: s.stop_coordinates.lon,
            }))
          );
        });

        /* ===========================
        IV ‚Äî CARTE
      =========================== */
        const map = L.map("map").setView([47.2184, -1.5536], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(
          map
        );
        let stopLayer = L.layerGroup().addTo(map);

        function displayStopsOnMap(list) {
          stopLayer.clearLayers();
          const resultsEl = document.getElementById("results");
          resultsEl.innerHTML = "";
          list.forEach((s) => {
            const m = L.marker([s.stop_lat, s.stop_lon]).addTo(stopLayer);
            m.bindPopup(`<strong>${s.stop_name}</strong>`);
            const div = document.createElement("div");
            div.className = "stop";
            div.innerHTML = `<div><strong>${s.stop_name}</strong> <span class="hint">[${s.stop_id}]</span></div>
            <div style="margin-top:8px"><button data-stop="${s.stop_id}">‚è± Voir passages</button></div>
            <div class="eta" data-eta-for="${s.stop_id}"></div>`;
            resultsEl.appendChild(div);
            div
              .querySelector("button")
              .addEventListener("click", () =>
                showTimesDiv(s.stop_id, div.querySelector(".eta"))
              );
          });
        }

        /* ===========================
        V ‚Äî HORAIRES
      =========================== */
        async function showTimesDiv(stopId, el) {
          el.innerHTML = "Chargement ...";

          const response = await fetch(
            "https://open.tan.fr/ewp/tempsattente.json/" + stopId
          );
          const data = await response.json();

          const fields = [];
          for (const dep of data) {
            const field = fields.find(
              (f) =>
                f.line == dep.ligne.numLigne && dep.terminus == dep.terminus
            );
            if (field) {
              if (dep.temps) {
                field.times.push({
                  time:
                    dep.temps === "proche"
                      ? 0
                      : parseInt(dep.temps.replace("mn", "")),
                  isLast: dep.dernierDepart === "true",
                  isRealTime: dep.tempsReel === "true",
                });
                field.times = field.times.sort((a, b) => a.time - b.time);
              }
            } else {
              fields.push({
                line: dep.ligne.numLigne,
                terminus: dep.terminus,
                times: dep.temps
                  ? [
                      {
                        time:
                          dep.temps === "proche"
                            ? 0
                            : parseInt(dep.temps.replace("mn", "")),
                        isLast: dep.dernierDepart === "true",
                        isRealTime: dep.tempsReel === "true",
                      },
                    ]
                  : [],
              });
            }
          }

          if (fields.length == 0) {
            el.innerHTML = "Aucun d√©part";
          } else {
            el.innerHTML = "";
            for (const field of fields) {
              const e = document.createElement("div");
              e.style.width = "100%";
              e.style.display = "flex";
              e.style.alignItems = "center";
              e.style.justifyContent = "space-between";
              e.style.margin = "10px";

              const title = document.createElement("div");
              title.style.display = "flex";
              title.style.alignItems = "center";

              const line = document.createElement("img");
              line.alt = field.line;
              line.src =
                "https://naolib-a-quai.simonlept.fr/src/assets/lines/" +
                field.line.toLowerCase() +
                ".svg";
              line.style.height = "30px";

              const terminus = document.createElement("div");
              terminus.innerText = field.terminus;
              terminus.style.marginLeft = "5px";

              const times = document.createElement("div");
              times.style.display = "flex";
              times.style.alignItems = "center";
              times.style.justifyContent = "center";
              times.style.gap = "5px";
              if (field.times.length == 0) {
                times.innerText = "Aucun d√©part";
              } else {
                for (const dep of field.times) {
                  const d = document.createElement("div");
                  d.innerText = dep.time + "mn";
                  if (!dep.isRealTime) {
                    d.innerText += "'";
                  }
                  if (dep.isLast) {
                    d.innerText += " (dernier)";
                  }

                  times.appendChild(d);
                }
              }

              title.appendChild(line);
              title.appendChild(terminus);
              e.appendChild(title);
              e.appendChild(times);
              el.appendChild(e);
            }
          }
        }

        /* ===========================
        VI ‚Äî RECHERCHE ET LOCALISATION
      =========================== */
        document.getElementById("searchBtn").addEventListener("click", () => {
          const q = document.getElementById("locInput").value.toLowerCase();
          if (!q) {
            displayStopsOnMap(stops);
            return;
          }
          const filtered = stops.filter((s) =>
            s.stop_name.toLowerCase().includes(q)
          );
          displayStopsOnMap(filtered);
        });

        document.getElementById("locBtn").addEventListener("click", () => {
          if (!navigator.geolocation) {
            alert("G√©olocalisation non support√©e");
            return;
          }
          navigator.geolocation.getCurrentPosition((pos) => {
            map.setView([pos.coords.latitude, pos.coords.longitude], 15);
            L.circle([pos.coords.latitude, pos.coords.longitude], {
              radius: 40,
              color: "#0070c0",
              fillOpacity: 0.1,
            })
              .addTo(map)
              .bindPopup("Vous √™tes ici")
              .openPopup();
          });
        });

        /* ===========================
        VII ‚Äî INIT
      =========================== */
        displayStopsOnMap(stops);
      })();
    </script>
  </body>
</html>
